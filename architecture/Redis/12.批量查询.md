# Redis批量查询
## 为什么批量执行命令
- 提高命令执行效率：减少了网络延迟，从而提高了 Redis 服务器的响应速度。批量执行减少了每个命令的单独网络传输开销，有效降低了往返时间（RTT）。
- 简化客户端逻辑：通过将多个命令封装成一个操作，客户端的处理逻辑变得更加简洁和清晰。这使得客户端代码更易读、易维护。
- 提升事务性能：批量执行命令能够确保一组命令在同一时间内执行，从而提高了事务的性能。这对于需要保持原子性的操作尤为重要，确保一组命令要么全部执行成功，要么全部失败。
## 批量查询的方式
### 字符串 MGET命令
- 用于批量获取多个字符串键的值。它接受一个或多个键作为参数，返回与这些键关联的值。
- MGET 返回一个包含相应值的列表，如果键不存在，则对应的位置返回 nil。

### 哈希表 HMGET命令
- 用于获取哈希表中指定字段的值。它接受一个哈希表的键以及一个或多个字段名作为参数，返回与这些字段名关联的值。
- 如果给定的域不存在于哈希表，那么返回一个 nil 值。
- 因为不存在的 key 被当作一个空哈希表来处理，所以对一个不存在的 key 进行 HMGET 操作将返回一个只带有 nil 值的表。

### 管道技术
- 一种优化网络通信的技术，可以将多个命令一次性发送给 Redis 服务器，可以减少客户端与 Redis 服务器之间的网络通信次数。
- 客户端将多个命令一次性发送给 Redis 服务器，Redis 服务器缓存这些命令，并一次性执行，最后将执行结果一次性返回给客户端。
- 注意
  - Redis Cluster 中 Pipeline 命令操作可能无法保证原子性，由于 Redis Cluster 采用的是分片机制，这些键无法保证所有的 key 都在同一区域的哈希槽上。因此，即使使用了 Pipeline，每个命令仍可能在不同的节点上进行处理，导致多个命令的执行不在同一时刻。
  - Pipeline 能执行有依赖关系的命令吗？ 不可以。如果 Pipeline 中后一个命令的执行依赖于前一个命令的执行结果，Pipeline 无法满足这样的需求。
  - Pipeline 对发送的命令有数量限制吗？ 虽然命令可以一次性发给 Redis 服务端，但是考虑到带宽等情况，建议不要超过500个命令，或者根据实际命令的数据类型和大小进行调整。这样可以避免潜在的性能问题。
### Lua 脚本
- Redis Lua 脚本是一种在 Redis 服务器上执行的脚本语言，基于 Lua 编程语言。
- 这种脚本可以包含多个 Redis 命令，而且它们在 Redis 服务器上以原子性操作的方式执行。通过使用 Lua 脚本，你可以在服务器端执行一系列的 Redis 命令，而不需要将它们一条一条地发送到服务器。
- Redis 执行 Lua 脚本有两种执行方式：Eval 和 EvalSHA 。
  - Eval
    - 1、根据客户端提供的 Lua 脚本，在 Lua 环境中定义一个 Lua 函数。Lua 函数的名称实际上是以 "f_" 为前缀加上脚本本身计算出的 SHA1 值，例如 f_ddfsdfjgjbg33rndgj00，其中 SHA1 的长度为40字符。函数体则是脚本本身。
    - 2、将客户端提供的脚本保存到 lua_scripts 字典中。简单来说，就是添加一个键值对，其中键是 Lua 脚本的 SHA1 校验和，值是 Lua 脚本本身。这主要是为了以后能够复用这个脚本。
    - 3、执行第一步在 Lua 环境中定义的函数，从而执行客户端提供的 Lua 脚本。这个过程利用了在步骤二中保存的 SHA1 校验和来调用对应的 Lua 函数。
  - EvalSha
    - 与 EVAL 不同，EVALSHA 的主要目的是通过脚本的 SHA1 校验和来执行预先在服务器端加载的 Lua 脚本，从而避免重复传输脚本的开销。
    - 1、加载 Lua 脚本到 Redis 服务端。首先，将 Lua 脚本加载到 Redis 服务端。这可以通过 SCRIPT LOAD 命令完成。执行 SCRIPT LOAD 后，会返回一个 SHA1 校验和，该值唯一标识了加载的 Lua 脚本。
    - 2、执行 Lua 脚本。一旦 Lua 脚本被加载并获得了 SHA1 校验和，之后就可以使用 EVALSHA 命令来执行该脚本。